<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CDN para convertir HTML a Canvas/Imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- CDN para generar el PDF a partir del Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        
        // Clave de almacenamiento local para guardar todos los reportes
        const STORAGE_KEY = 'sales_reports_data_manual_cop_v6_decimal';
        
        // Global variable to hold the last viewed report for sharing/printing
        let currentReportToShare = null; 
        
        // --- Lista Maestra de Productos ---
        const MASTER_PRODUCTS = [
            // isDecimal: true para Masa, donde el input de cantidad es en GRAMOS ENTEROS y el precio es por KILO.
            { id: 'PROD01', name: 'Masa', isDecimal: true }, 
            { id: 'PROD02', name: 'Palos de Queso', isDecimal: false },
            { id: 'PROD03', name: 'Panzeroti', isDecimal: false },
            { id: 'PROD04', name: 'Queso Mozarella', isDecimal: false },
            { id: 'PROD05', name: 'Gaseosas', isDecimal: false },
            { id: 'PROD06', name: 'Coca-Cola', isDecimal: false },
            { id: 'PROD07', name: 'Agua Grande', isDecimal: false },
            { id: 'PROD08', name: 'Torta Chocolo', isDecimal: false },
            { id: 'PROD09', name: 'Salchichón', isDecimal: false },
            { id: 'PROD10', name: 'Torta de Carne', isDecimal: false },
            { id: 'PROD11', name: 'Tinto', isDecimal: false },
            { id: 'PROD12', name: 'Café', isDecimal: false },
            { id: 'PROD13', name: 'Pastel de Pollo', isDecimal: false },
            { id: 'PROD14', name: 'Arepa Huevo', isDecimal: false },
            { id: 'PROD15', name: 'Empanada', isDecimal: false },
            { id: 'PROD16', name: 'Empanada Paisa', isDecimal: false },
            { id: 'PROD17', name: 'Papas', isDecimal: false },
            { id: 'PROD18', name: 'Galletas', isDecimal: false },
			{ id: 'PROD19', name: 'Cigarrillos', isDecimal: false },
        ];
        
        /**
         * Obtiene la fecha actual en formato ISO local (YYYY-MM-DD)
         */
        function getLocalISODate() {
            const d = new Date();
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Formatea un número como Peso Colombiano (COP).
         */
        const formatCurrency = (number) => {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP', 
                minimumFractionDigits: 0 
            }).format(number);
        };
        
        const formatDate = (dateString) => {
            const date = new Date(dateString.replace(/-/g, '/')); 
            return date.toLocaleDateString('es-CO', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
        };

        const formatTime = (timestampString) => {
            const date = new Date(timestampString);
            return date.toLocaleTimeString('es-CO', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true, 
                timeZone: 'America/Bogota'
            });
        };
        
        function handleInputFocus(input) {
            const currentValue = input.value.trim();
            if (currentValue === '0' || currentValue === '0.0' || currentValue === '0.00') {
                input.value = '';
            }
        }

        function handleInputBlur(input) {
            if (input.value.trim() === '') {
                input.value = 0;
            }
            // Recalcular al perder foco
            recalculateReport();
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const localIsoDate = getLocalISODate();
            document.getElementById('report-date-display').value = formatDate(localIsoDate);
            document.getElementById('report-date-value').value = localIsoDate;

            document.getElementById('add-product-btn').addEventListener('click', () => addProductCard({}));
            document.getElementById('save-report-btn').addEventListener('click', saveReport);
            
            // Listener para el botón de agregar movimiento
            document.getElementById('add-movement-btn').addEventListener('click', addMovementRow);
            
            // Listener para el botón de compartir PDF (Lógica de PDF)
            document.getElementById('share-boucher-btn').addEventListener('click', () => {
                if (currentReportToShare) {
                    generateAndSharePDF(currentReportToShare);
                } else {
                    displayMessage("Error: No hay reporte para compartir.", 'error');
                }
            });
            
            // --- LISTENERS DELEGADOS ---
            const reportArea = document.getElementById('main-report-area');
            
            reportArea.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT') {
                    if (e.target.name === 'precio' || e.target.name === 'entregada' || e.target.name === 'sobrante' || e.target.id === 'cash-amount' || e.target.id === 'employee-breakfast' || e.target.classList.contains('movement-value')) {
                        recalculateReport();
                    }
                }
                if (e.target.tagName === 'SELECT' && e.target.classList.contains('movement-type')) {
                    recalculateReport();
                }
            });
            
            reportArea.addEventListener('focusin', (e) => {
                 if (e.target.tagName === 'INPUT' && (e.target.name === 'precio' || e.target.name === 'entregada' || e.target.name === 'sobrante' || e.target.id === 'cash-amount' || e.target.id === 'employee-breakfast' || e.target.classList.contains('movement-value'))) {
                    handleInputFocus(e.target);
                }
            });

            reportArea.addEventListener('focusout', (e) => {
                if (e.target.tagName === 'INPUT' && (e.target.name === 'precio' || e.target.name === 'entregada' || e.target.name === 'sobrante' || e.target.id === 'cash-amount' || e.target.id === 'employee-breakfast' || e.target.classList.contains('movement-value'))) {
                    handleInputBlur(e.target);
                }
            });
            
            // Delegación para eliminar movimientos dinámicos
            reportArea.addEventListener('click', (e) => {
                if (e.target.closest('.remove-movement-btn')) {
                    e.target.closest('.movement-row').remove();
                    recalculateReport();
                }
            });


            const reportList = document.getElementById('report-list');
            reportList.addEventListener('change', (e) => {
                if (e.target.name === 'productoId') {
                    const card = e.target.closest('.product-card');
                    if (card) {
                        updateQuantityInputType(card);
                    }
                }
            });
            
            loadReportHistory(); 
            if (reportList.children.length === 0) {
                 addProductCard({});
            }
            
            recalculateReport();
            
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('print-boucher-btn').addEventListener('click', printBoucher);
        });

        // --- Core Functions ---

        function updateQuantityInputType(card) {
            const select = card.querySelector('[name="productoId"]');
            const entregadaInput = card.querySelector('[name="entregada"]');
            const sobranteInput = card.querySelector('[name="sobrante"]');
            const precioLabel = card.querySelector('[name="precio-label"]');

            if (!select || !entregadaInput || !sobranteInput) return;

            const productId = select.value;
            const isMasaProduct = productId === 'PROD01'; 
            
            let unitText = 'Unidades';
            let priceUnitText = 'Precio';
            if (isMasaProduct) {
                unitText = 'Gramos (gr)';
                priceUnitText = 'Precio por KILO'; 
            }
            
            const stepValue = '1';
            
            entregadaInput.setAttribute('step', stepValue);
            sobranteInput.setAttribute('step', stepValue);
            
            const labelEntregada = card.querySelector('[name="entregada-label"]');
            const labelSobrante = card.querySelector('[name="sobrante-label"]');

            if (labelEntregada) labelEntregada.textContent = `Cant. Entregada`;
            if (labelSobrante) labelSobrante.textContent = `Cant. Sobrante`;
            if (precioLabel) precioLabel.textContent = priceUnitText;
            
            const vendidaUnitLabel = card.querySelector('[name="vendida-unit-label"]');
            if (vendidaUnitLabel) vendidaUnitLabel.textContent = unitText; 

            recalculateReport();
        }

        function getProductSelectHTML(selectedId = '') {
            let options = MASTER_PRODUCTS.map(p => 
                `<option value="${p.id}" ${selectedId === p.id ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            
            return `
                <select name="productoId" class="select-product w-full p-3 bg-white border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base font-semibold text-gray-800">
                    <option value="" disabled selected>-- Seleccione Producto --</option>
                    ${options}
                </select>
            `;
        }

        function addProductCard(productData = {}) {
            const listContainer = document.getElementById('report-list');
            const newCard = document.createElement('div');
            newCard.classList.add('product-card', 'bg-white', 'p-4', 'rounded-2xl', 'shadow-md', 'mb-4', 'border', 'border-gray-200');
            
            const defaults = { 
                productoId: productData.productoId || '', 
                precio: productData.precio || 0, 
                entregada: productData.entregada || 0, 
                sobrante: productData.sobrante || 0,
            };

            const uniqueId = `prod-${Date.now()}-${listContainer.children.length}`;

            newCard.innerHTML = `
                <div class="flex justify-between items-start mb-3 border-b pb-3">
                    <div class="flex-grow">
                         <label class="block text-xs font-medium text-indigo-600 mb-1">Producto</label>
                         ${getProductSelectHTML(defaults.productoId)}
                    </div>
                    <button type="button" class="remove-card-btn text-red-500 hover:text-red-700 p-2 ml-2 transition" title="Eliminar Producto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label for="${uniqueId}-precio" name="precio-label" class="block text-xs font-medium text-gray-500 mb-1">Precio</label>
                        <input id="${uniqueId}-precio" type="number" name="precio" value="${defaults.precio}" min="0" step="100" inputmode="numeric" class="input-field-mobile w-full text-center bg-gray-100 font-semibold border-gray-400">
                    </div>
                    <div>
                        <label for="${uniqueId}-entregada" name="entregada-label" class="block text-xs font-medium text-gray-500 mb-1">Cant. Entregada</label>
                        <input id="${uniqueId}-entregada" type="number" name="entregada" value="${defaults.entregada}" min="0" step="1" inputmode="numeric" class="input-field-mobile w-full text-center bg-blue-50">
                    </div>
                    <div>
                        <label for="${uniqueId}-sobrante" name="sobrante-label" class="block text-xs font-medium text-gray-500 mb-1">Cant. Sobrante</label>
                        <input id="${uniqueId}-sobrante" type="number" name="sobrante" value="${defaults.sobrante}" min="0" step="1" inputmode="numeric" class="input-field-mobile w-full text-center bg-yellow-50">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-3 border-t border-gray-100">
                    <div class="bg-indigo-50 p-3 rounded-xl text-center">
                        <p class="text-xs font-medium text-indigo-600">Cant. Vendida (<span name="vendida-unit-label">Unidades</span>)</p>
                        <p name="vendida" class="text-xl font-bold text-indigo-800 mt-0.5">0</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl text-center">
                        <p class="text-xs font-medium text-green-600">Valor Total Mercancia</p>
                        <p name="totalVenta" class="text-xl font-bold text-green-800 mt-0.5">0</p>
                    </div>
                </div>
            `;
            
            listContainer.appendChild(newCard);
            
            const removeBtn = newCard.querySelector('.remove-card-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', (e) => removeProductCard(e.target));
            }
            updateQuantityInputType(newCard);
        }
        
        function removeProductCard(element) {
            const card = element.closest('.product-card');
            if (card) {
                card.remove();
                recalculateReport();
            }
        }

        // --- Inputs Dinámicos de Movimiento ---
        
        function addMovementRow() {
            const container = document.getElementById('movements-list');
            const row = document.createElement('div');
            row.className = 'movement-row flex items-center space-x-2 mb-2';
            row.innerHTML = `
                <select class="movement-type input-field-mobile bg-white w-1/4 text-xs px-1">
                    <option value="expense">(-) Gasto</option>
                    <option value="income">(+) Ingreso</option>
                </select>
                <input type="text" placeholder="Concepto" class="movement-name input-field-mobile bg-white w-1/3 text-left text-xs">
                <input type="number" placeholder="0" value="0" step="1000" class="movement-value input-field-mobile bg-white w-1/3 text-right font-semibold">
                <button type="button" class="remove-movement-btn text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            container.appendChild(row);
        }

        // Esta función calcula (Ingresos - Gastos).
        // Si hay mas gastos, devuelve un numero negativo.
        function getMovementsTotal() {
            let total = 0;
            const rows = document.querySelectorAll('.movement-row');
            rows.forEach(row => {
                const type = row.querySelector('.movement-type').value;
                const value = parseFloat(row.querySelector('.movement-value').value) || 0;
                if (type === 'expense') {
                    total -= value;
                } else {
                    total += value;
                }
            });
            return total;
        }
        
        function recalculateReport() {
            let grandTotalSales = 0;
            const productCards = document.querySelectorAll('.product-card');

            for (let i = 0; i < productCards.length; i++) {
                const card = productCards[i];
                const productId = card.querySelector('[name="productoId"]')?.value;
                const isMasaProduct = productId === 'PROD01';
                const precio = parseFloat(card.querySelector('[name="precio"]')?.value) || 0; 
                const entregada = parseFloat(card.querySelector('[name="entregada"]')?.value) || 0;
                const sobranteInput = card.querySelector('[name="sobrante"]'); 
                const sobrante = parseFloat(sobranteInput?.value) || 0;
                
                if (sobrante > entregada) {
                   sobranteInput?.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                } else {
                   sobranteInput?.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                }

                const vendida = Math.max(0, entregada - sobrante); 
                let totalVenta = 0;
                
                if (isMasaProduct) {
                    const kilosPorGramo = 1000;
                    const vendidaKilos = vendida / kilosPorGramo; 
                    totalVenta = precio * vendidaKilos; 
                } else {
                    totalVenta = precio * vendida; 
                }
                
                const vendidaDisplay = card.querySelector('[name="vendida"]');
                const totalVentaDisplay = card.querySelector('[name="totalVenta"]');
                const vendidaFormatted = Math.round(vendida).toString(); 

                if (vendidaDisplay) vendidaDisplay.textContent = vendidaFormatted;
                if (totalVentaDisplay) totalVentaDisplay.textContent = formatCurrency(totalVenta);

                grandTotalSales += totalVenta;
            }
            
            const totalVentasMercancia = Math.round(grandTotalSales);

            // 1. Obtener Dinero de Caja
            const cashAmountInput = document.getElementById('cash-amount');
            const dineroCaja = Math.round(parseFloat(cashAmountInput?.value) || 0);
            
            // 2. Obtener Desayuno de Empleado
            const breakfastInput = document.getElementById('employee-breakfast');
            const valorDesayuno = Math.round(parseFloat(breakfastInput?.value) || 0);

            // 3. Ventas Ajustadas (Mercancia Vendida - Desayuno)
            const ventasAjustadas = totalVentasMercancia - valorDesayuno; 
            
            // 4. Obtener Movimientos Netos (Ingresos - Gastos)
            const movementsTotal = getMovementsTotal();

            // 5. Calcular Total Final en Caja (Dinero Físico + Movimientos Netos)
            const totalFinalEnCaja = dineroCaja + movementsTotal;

            // 6. Calcular Diferencia (Saldo)
            // Fórmula solicitada: SALDO FINAL = TOTAL FINAL EN CAJA - TOTAL VENTAS AJUSTADAS
            const diferencia = totalFinalEnCaja - ventasAjustadas; 
            
            // 7. Actualizar Resumen Fijo
            
            // Etiqueta cambiada a 'Valor Mercancia'
            const labelVentasDisplay = document.querySelector('.fixed-summary-bar p.text-xs.font-medium.text-gray-500');
            if (labelVentasDisplay) labelVentasDisplay.textContent = "Valor Mercancia";

            const grandTotalSalesDisplay = document.getElementById('grand-total-sales-display');
            const cashDifferenceDisplay = document.getElementById('cash-difference-display');
            const cashDifferenceLabel = document.getElementById('cash-difference-label');
            
            // Mostrar Ventas Ajustadas en el resumen fijo
            if (grandTotalSalesDisplay) grandTotalSalesDisplay.textContent = formatCurrency(ventasAjustadas); 
            
            if (cashDifferenceDisplay) {
                cashDifferenceDisplay.textContent = formatCurrency(Math.abs(diferencia));
                cashDifferenceDisplay.classList.remove('text-green-600', 'text-red-600', 'text-gray-600');
                
                if (diferencia > 0) {
                    cashDifferenceLabel.textContent = 'Saldo a Favor'; 
                    cashDifferenceDisplay.classList.add('text-green-600');
                } else if (diferencia < 0) {
                    cashDifferenceLabel.textContent = 'Saldo Faltante'; 
                    cashDifferenceDisplay.classList.add('text-red-600');
                } else {
                    cashDifferenceLabel.textContent = 'Saldo (Cero)';
                    cashDifferenceDisplay.classList.add('text-gray-600');
                }
            }
        }
        
        // --- Local Storage Functions ---

        function getReportsFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error al leer de localStorage:", error);
                return [];
            }
        }

        function saveReportsToLocalStorage(reports) {
            try {
                reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
            } catch (error) {
                console.error("Error al escribir en localStorage:", error);
                displayMessage("Error al guardar el reporte localmente.", 'error');
            }
        }

        function loadReportHistory() {
            const historyContainer = document.getElementById('report-history-cards');
            const reports = getReportsFromLocalStorage();

            if (reports.length === 0) {
                historyContainer.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No hay reportes guardados localmente.</p>`;
                return;
            }
            
            let historyHTML = '';
            reports.slice(0, 5).forEach((data, index) => {
                const formattedTime = formatTime(data.timestamp);
                const formattedDateShort = formatDate(data.date).split(',')[1].trim(); 
                
                let saldoClase = 'text-gray-600';
                let saldoTipo = 'Cero';
                if (data.diferencia > 0) {
                    saldoClase = 'text-green-600';
                    saldoTipo = 'Favor';
                } else if (data.diferencia < 0) {
                    saldoClase = 'text-red-600';
                    saldoTipo = 'Faltante';
                }
                
                // Compatibility: use totalVentasAjustadas or fall back to previous structures
                const displayTotal = data.ventasAjustadas !== undefined ? data.ventasAjustadas : (data.totalVentasMercancia || data.ventasEsperadasNetas || 0);

                const productDetails = data.products.map(p => {
                    if (p.totalVenta > 0) { 
                        return `
                            <li class="flex justify-between text-xs text-gray-700 py-1 border-b border-dashed">
                                <span class="truncate pr-2">${p.productName}</span>
                                <span class="font-medium text-right">${formatCurrency(p.totalVenta)}</span>
                            </li>
                        `;
                    }
                    return ''; 
                }).join('');

                // NUEVO: Botón "Ver Detalle" en el historial con listener
                historyHTML += `
                    <div class="bg-white p-4 rounded-xl border border-indigo-200 shadow-sm history-card mr-4 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-center border-b pb-2 mb-2">
                                <h4 class="font-bold text-indigo-700 truncate">${data.posName}</h4>
                                <span class="text-xs text-gray-500">${formattedDateShort}</span>
                            </div>
                            <div class="mb-3">
                                <div>
                                    <p class="text-sm text-gray-600">Valor Mercancia	:</p>
                                    <p class="text-xl font-extrabold text-green-700">${formatCurrency(displayTotal)}</p>
                                </div>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-600">Saldo (${saldoTipo}):</p>
                                    <p class="text-xl font-extrabold ${saldoClase}">${formatCurrency(Math.abs(data.diferencia))}</p>
                                </div>
                            </div>
                            
                            <!-- Detalle de Productos -->
                            <div class="mt-3 pt-2 border-t border-gray-100">
                                 <h5 class="text-xs font-bold text-gray-700 mb-1">Producto:</h5>
                                 <ul class="space-y-0.5 max-h-24 overflow-y-auto">
                                     ${productDetails || '<li class="text-xs text-gray-500">Sin ventas registradas.</li>'}
                                 </ul>
                            </div>
                        </div>

                        <div class="mt-3 pt-2 border-t border-gray-100">
                            <p class="text-xs text-gray-400 mt-1 text-right">Guardado: ${formattedTime}</p>
                            <button data-report-index="${index}" class="view-boucher-btn w-full mt-2 py-2 text-xs font-semibold text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                                Ver Detalle
                            </button>
                        </div>
                    </div>
                `;
            }); 
            historyContainer.innerHTML = `<div class="flex overflow-x-auto pb-4">${historyHTML}</div>`;
            
            // NUEVO: Asignar listener a los botones de "Ver Detalle" generados
            document.querySelectorAll('.view-boucher-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.reportIndex);
                    const allReports = getReportsFromLocalStorage();
                    if (allReports[index]) {
                        generateBoucher(allReports[index]);
                    }
                });
            });
        }

        function saveReport() {
            const reportDate = document.getElementById('report-date-value').value;
            const posName = document.getElementById('pos-name').value.trim();
            const cashAmountInput = document.getElementById('cash-amount');
            const dineroCaja = Math.round(parseFloat(cashAmountInput.value) || 0); 
            const breakfastInput = document.getElementById('employee-breakfast');
            const valorDesayuno = Math.round(parseFloat(breakfastInput.value) || 0); // NUEVO: Valor Desayuno
            const productCards = document.querySelectorAll('.product-card');
            const reportData = [];

            if (!reportDate) {
                displayMessage("Error: No se pudo obtener la fecha de registro.", 'error');
                return;
            }
            if (posName === "") {
                displayMessage("Ingresa el Nombre del Punto de Venta.", 'warning');
                document.getElementById('pos-name').focus();
                return;
            }
            if (productCards.length === 0) {
                 displayMessage("Agrega al menos un producto al reporte.", 'warning');
                 return;
            }

            let isValid = true;
            for (let i = 0; i < productCards.length; i++) {
                const card = productCards[i];
                const select = card.querySelector('[name="productoId"]');
                const productoId = select?.value.trim() || "";
                const productName = select?.options[select.selectedIndex]?.text || "Producto Desconocido"; 
                
                if (productoId === "") {
                    isValid = false;
                    break;
                }
                
                const productMeta = MASTER_PRODUCTS.find(mp => mp.id === productoId);
                const isMasaProduct = productMeta && productMeta.id === 'PROD01';
                const precio = parseFloat(card.querySelector('[name="precio"]')?.value) || 0;
                const entregada = Math.round(parseFloat(card.querySelector('[name="entregada"]')?.value) || 0);
                const sobrante = Math.round(parseFloat(card.querySelector('[name="sobrante"]')?.value) || 0);
                
                 if (sobrante > entregada) {
                    isValid = false;
                    continue; 
                }
                
                const vendida = Math.max(0, entregada - sobrante);
                let totalVenta = 0;

                if (isMasaProduct) {
                    const kilosPorGramo = 1000;
                    const vendidaKilos = vendida / kilosPorGramo;
                    totalVenta = precio * vendidaKilos; 
                } else {
                    totalVenta = precio * vendida; 
                }
                
                reportData.push({
                    productoId: productoId,
                    productName: productName, 
                    precio: precio,
                    entregada: entregada, 
                    sobrante: sobrante,
                    vendida: vendida, 
                    totalVenta: Math.round(totalVenta),
                    isDecimal: isMasaProduct, 
                });
            }
            
            if (!isValid) {
                 displayMessage("Corrige los errores de validación (sobrantes > entregados).", 'error');
                 return;
            }

            const totalVentasMercancia = reportData.reduce((acc, item) => acc + item.totalVenta, 0);
            
            // Recopilar movimientos
            const movements = [];
            document.querySelectorAll('.movement-row').forEach(row => {
                const type = row.querySelector('.movement-type').value;
                const name = row.querySelector('.movement-name').value || (type === 'expense' ? 'Gasto' : 'Ingreso');
                const value = parseFloat(row.querySelector('.movement-value').value) || 0;
                if (value !== 0) {
                    movements.push({ type, name, value });
                }
            });

            // Logic for Movements Total: Income - Expenses (Neto)
            const movementsTotal = movements.reduce((acc, m) => m.type === 'expense' ? acc + m.value : acc + m.value, 0);
            
            // NUEVO: Ventas Ajustadas (Mercancia - Desayuno)
            const ventasAjustadas = totalVentasMercancia - valorDesayuno;

            // NUEVO: Total Final en Caja (Dinero Físico + Movimientos Netos)
            const totalFinalEnCaja = dineroCaja + movementsTotal;
            
            // Lógica MODIFICADA: SALDO FINAL = TOTAL FINAL EN CAJA - TOTAL VENTAS AJUSTADAS
            const diferencia = totalFinalEnCaja - Math.round(ventasAjustadas);
            
            const finalReport = {
                date: reportDate,
                posName: posName, 
                dineroCaja: dineroCaja, 
                totalVentasMercancia: Math.round(totalVentasMercancia), 
                valorDesayuno: valorDesayuno, 
                ventasAjustadas: Math.round(ventasAjustadas), 
                movements: movements,
                movementsNetTotal: Math.round(movementsTotal), 
                diferencia: diferencia,
                products: reportData, 
                timestamp: new Date().toISOString()
            };
            
            generateBoucher(finalReport);
            const reports = getReportsFromLocalStorage();
            reports.push(finalReport);
            saveReportsToLocalStorage(reports);
            
            let summaryMessage = `Reporte de ${posName} guardado.`;
            displayMessage(summaryMessage, diferencia < 0 ? 'warning' : 'success');
            
            // Limpiar inputs
            document.getElementById('report-list').innerHTML = '';
            document.getElementById('movements-list').innerHTML = ''; 
            document.getElementById('cash-amount').value = 0;
            document.getElementById('employee-breakfast').value = 0; // Limpiar Desayuno
            addProductCard({}); 
            loadReportHistory(); 
            recalculateReport();
        }
        
        // --- BOUCHER GENERATION AND DISPLAY ---
        
        function getReportSummaryText(report) {
            const formattedDate = formatDate(report.date);
            const formattedTime = formatTime(report.timestamp);

            let summary = `*-- Cierre de Caja: ${report.posName} --*\n`;
            summary += `Fecha: ${formattedDate} (${formattedTime})\n\n`;

            // 1. Mercancía Vendida
            summary += `*1. Resumen de Ventas:*\n`;
            report.products.forEach(p => {
                if (p.totalVenta > 0) {
                    const unitText = p.isDecimal ? 'gr' : 'unid.'; 
                    summary += `  • ${p.productName}: ${Math.round(p.vendida)} ${unitText} (${formatCurrency(p.totalVenta)})\n`;
                }
            });
            summary += `\n*TOTAL MERCANCIA: ${formatCurrency(report.totalVentasMercancia)}*\n`;
            
            // Ajuste por Desayuno
            summary += `  (-) Desayuno: ${formatCurrency(report.valorDesayuno || 0)}\n`;
            summary += `*AJUSTE MERCANCIA: ${formatCurrency(report.ventasAjustadas)}*\n\n`;


            // 2. Movimientos y Caja
            summary += `*2. Caja y Movimientos:*\n`;
            summary += `  - Dinero en Caja: ${formatCurrency(report.dineroCaja)}\n`;
            
            if (report.movements && report.movements.length > 0) {
                report.movements.forEach(m => {
                    const sign = m.type === 'expense' ? '(-)' : '(+)';
                    summary += `  • ${m.name}: ${sign} ${formatCurrency(m.value)}\n`;
                });
                const netType = report.movementsNetTotal >= 0 ? 'Ingreso Neto' : 'Gasto Neto';
                summary += `  -> Total Movimientos: ${formatCurrency(report.movementsNetTotal)} (${netType})\n`;
            } else {
                summary += `  (Sin movimientos extra)\n`;
            }
            // Mostrar la suma para claridad
            const totalFinalEnCaja = (report.dineroCaja || 0) + (report.movementsNetTotal || 0);
            summary += `  *TOTAL FINAL EN CAJA: ${formatCurrency(totalFinalEnCaja)}*\n\n`;

            // 3. Saldo Final
            const saldoTipo = report.diferencia === 0 ? 'CERO' : (report.diferencia > 0 ? 'A FAVOR' : 'FALTANTE');
            summary += `*3. Comparación Final:*\n`;
            summary += `  (Total Final en Caja) - (Ventas Ajustadas)\n`;
            summary += `  ${formatCurrency(totalFinalEnCaja)} - ${formatCurrency(report.ventasAjustadas)}\n`;
            summary += `  *SALDO FINAL (${saldoTipo}): ${formatCurrency(report.diferencia)}*\n\n`;
            summary += `_Generado por Sistema de Reporte Diario_`;

            return summary;
        }

        /**
         * NUEVA FUNCIÓN: Genera el PDF del boucher y usa el Web Share API para compartirlo.
         * En caso de no soportar archivos, cae a la descarga automática.
         */
        async function generateAndSharePDF(report) {
            const pdfButton = document.getElementById('share-boucher-btn');
            pdfButton.disabled = true;
            pdfButton.textContent = 'Generando PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const boucherContent = document.getElementById('boucher-content');
                const boucherModal = document.getElementById('boucher-modal');
                const tempBoucherContainer = document.getElementById('boucher-body');
                
                // 1. Clonar y preparar el contenido para html2canvas
                const clone = tempBoucherContainer.cloneNode(true);
                clone.style.width = '300px'; // Anchura fija para el PDF
                clone.style.backgroundColor = 'white';
                
                // Asegurar que el clon esté visible pero fuera del flujo
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                document.body.appendChild(clone);

                // 2. Generar el Canvas/Imagen
                const canvas = await html2canvas(clone, {
                    scale: 3, // Mayor escala para mejor resolución
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                // 3. Generar el PDF con jspdf
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4' // Usamos A4 para tener espacio
                });
                
                const imgWidth = 80; // Anchura deseada en el PDF (mm)
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 10; // Margen superior inicial

                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position);
                
                // Si el boucher es muy largo, añade más páginas
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // 4. Crear el Blob/File para la compartición
                const pdfBlob = pdf.output('blob');
                const fileName = `Reporte_${report.posName.replace(/\s/g, '_')}_${report.date}.pdf`;
                const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

                // 5. Intentar compartir el archivo (Web Share API)
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    await navigator.share({
                        files: [pdfFile],
                        title: `Reporte de Caja - ${report.posName}`,
                        text: getReportSummaryText(report).substring(0, 200) + '...', // Texto corto como descripción
                    });
                    displayMessage("PDF compartido exitosamente.", 'success');
                } else {
                    // Fallback: Descargar el archivo
                    pdf.save(fileName);
                    displayMessage('Compartición de archivos no soportada. PDF descargado automáticamente.', 'warning');
                }
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Error al generar o compartir el PDF:", error);
                    displayMessage(`Error al compartir: ${error.message}. Se intentará descargar.`, 'error');
                    
                    // Fallback de descarga si todo lo demás falla
                    const reportName = `Reporte_${report.posName.replace(/\s/g, '_')}_${report.date}.pdf`;
                    window.open(pdf.output('bloburl'), '_blank'); // Abre el PDF en una nueva pestaña para descarga manual
                }
            } finally {
                // Limpieza
                const clone = document.body.querySelector('div[style*="-9999px"]');
                if (clone) clone.remove();
                
                pdfButton.disabled = false;
                pdfButton.textContent = 'Compartir Reporte (PDF)';
            }
        }
        
        function generateBoucher(report) {
            currentReportToShare = report; // Almacena el reporte para las funciones de compartir/imprimir

            const boucherBody = document.getElementById('boucher-body');
            const formattedDate = formatDate(report.date);
            const formattedTime = formatTime(report.timestamp);
            const relevantProducts = report.products.filter(p => p.vendida > 0 || p.sobrante > 0); 
            
            let saldoTipo = '--';
            let saldoColor = 'text-gray-700'; 
            if (report.diferencia > 0) {
                saldoTipo = 'A FAVOR';
                saldoColor = 'text-green-700'; 
            } else if (report.diferencia < 0){
			   saldoTipo = 'FALTANTE';
               saldoColor = 'text-red-700'; 
			}
			else if (report.diferencia === 0) {
                saldoTipo = 'CERO';
                saldoColor = 'text-gray-700'; 
            }

            // Calcular suma: Dinero en Caja + Movimientos Netos
            const totalFinalEnCaja = (report.dineroCaja || 0) + (report.movementsNetTotal || 0);

            const saldoHTML = `
                <div class="flex justify-between items-center text-base font-extrabold pt-2 border-t border-gray-200">
                    <span>SALDO FINAL:</span>
                    <span class="font-bold ${saldoColor}">${formatCurrency(Math.abs(report.diferencia))} (${saldoTipo})</span>
                </div>
            `;
            
            // Visualización Estandar: Gasto (-) Rojo, Ingreso (+) Verde
            const movementsHTML = report.movements && report.movements.length > 0 ? 
                report.movements.map(m => `
                    <div class="flex justify-between items-center text-xs text-black-600">
                        <span>${m.name}:</span>
                        <span class="${m.type === 'expense' ? 'text-black-600' : 'text-black-600'}">${m.type === 'expense' ? '(-)' : '(+)'} ${formatCurrency(m.value)}</span>
                    </div>
                `).join('') : '<div class="text-xs text-gray-400 italic">Sin movimientos extra.</div>';

            const detailRows = relevantProducts.map(p => {
                    const unitText = p.isDecimal ? 'gr' : 'unid.'; 
                    return `
                        <tr class="border-b border-dashed border-gray-200">
                            <td class="pr-2 pt-2">${p.productName}</td>
                            <td class="text-center whitespace-nowrap pt-2">${Math.round(p.vendida)} ${unitText}</td>
                            <td class="text-center whitespace-nowrap pt-2">${Math.round(p.sobrante)} ${unitText}</td>
                            <td class="text-right whitespace-nowrap pt-2">${formatCurrency(p.precio)}</td>
                            <td class="text-right font-semibold whitespace-nowrap pt-2">${formatCurrency(p.totalVenta)}</td>
                        </tr>
                    `;
                }).join('');
            
                boucherBody.innerHTML = `
                    <div class="space-y-1 mb-4 text-center">
                        <p class="text-lg font-bold text-gray-900">${report.posName}</p>
                        <p class="text-xs text-gray-500">Fecha: ${formattedDate}</p>
                        <p class="text-xs text-gray-500">Hora : ${formattedTime}</p>
                    </div>
                    <h4 class="text-center text-sm font-semibold mb-2 mt-4 text-indigo-700">DETALLES</h4>
                    <table class="w-full text-xs mb-4">
                        <thead class="border-b border-t border-gray-300">
                            <tr>
                                <th class="py-1 text-left">Producto</th>
                                <th class="text-center">Vend.</th>
                                <th class="text-center">Sobr.</th>
                                <th class="text-right">Precio</th>
                                <th class="text-right font-bold">Total</th>
                            </tr>
                        </thead>
                        <tbody>${detailRows}</tbody>
                    </table>
                    
                    <div class="border-t-2 border-dashed border-gray-400 pt-3 mt-4 space-y-2">
                        <!-- Venta Bruta -->
                        <div class="flex justify-between items-center text-sm font-bold text-gray-800 pb-2 mb-2">
                            <span>TOTAL MERCANCIA:</span>
                            <span class="text-green-700">${formatCurrency(report.totalVentasMercancia)}</span>
                        </div>
                        
                        <!-- Valor Desayuno Empleado -->
                        <div class="flex justify-between items-center text-xs font-medium text-gray-700">
                            <span>(-) Desayuno:</span>
                            <span class="font-bold text-red-500">${formatCurrency(report.valorDesayuno || 0)}</span>
                        </div>
                        
                        <!-- Venta Ajustada -->
                        <div class="flex justify-between items-center text-sm font-bold text-gray-800 pt-2 border-t border-gray-200 ">
                            <span>AJUSTE MERCANCIA:</span>
                            <span class="text-green-700">${formatCurrency(report.ventasAjustadas)}</span>
                        </div>

                        <div class="flex justify-between items-center text-sm font-medium text-gray-700 pt-2 border-t border-gray-200">
                            <span>Dinero en Caja:</span>
                            <span class="font-bold text-indigo-700">${formatCurrency(report.dineroCaja)}</span>
                        </div>

                        <div class="py-1 border-b border-gray-100">
                            <p class="text-xs font-semibold text-black-500 mb-1">(Gastos/Ingresos):</p>
                            ${movementsHTML}
                        </div>
                         
                         <!-- Total Neto Movimientos -->
                         <div class="flex justify-between items-center text-xs font-semibold text-black-600 pt-1 border-b border-gray-200 pb-2">
                            <span>Total Caja:</span>
							<span>${formatCurrency(totalFinalEnCaja)}</span>
                        </div>

                        <!-- NUEVA LÍNEA: Total Dinero en Caja (Físico + Movimientos) -->
                        <!-- <div class="flex justify-between items-center text-sm font-extrabold text-blue-800 bg-blue-50 p-2 rounded"> -->
                            <!-- <span>TOTAL EN CAJA:</span> -->
                            <!-- <span>${formatCurrency(totalFinalEnCaja)}</span> -->
                        <!-- </div> -->
                        
                        ${saldoHTML}
                    </div>
                    <div class="text-center mt-6 text-xs text-gray-500 border-t pt-3">
                     <p class="mt-1">¡Reporte guardado exitosamente!</p>
                    </div>
                `;
            
            openModal();
        }

        function openModal() {
            document.getElementById('boucher-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal() {
            document.getElementById('boucher-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        function printBoucher() {
            const boucherContent = document.getElementById('boucher-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Boucher de Cierre</title>');
            printWindow.document.write(`
                <style>
                    body { font-family: sans-serif; margin: 0; padding: 10px; font-size: 10px; width: 300px; }
                    h1, h2, h3, h4, h5, p { margin: 0; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 4px 0; border-color: #eee; }
                    .text-center { text-align: center; }
                    .text-right { text-align: right; }
                    .font-semibold { font-weight: 600; }
                    .font-bold { font-weight: 700; }
                    .font-extrabold { font-weight: 800; }
                    .border-b { border-bottom: 1px solid #ccc; }
                    .border-t { border-top: 1px solid #ccc; }
                    .border-t-2 { border-top: 2px dashed #333; }
                    .pt-2 { padding-top: 8px; }
                    .pt-3 { padding-top: 12px; }
                    .pb-3 { padding-bottom: 12px; }
                    .mt-4 { margin-top: 16px; }
                    .mt-5 { margin-top: 20px; }
                    .mt-6 { margin-top: 24px; }
                    .space-y-1 > p { margin-bottom: 4px; }
                    .flex { display: flex; }
                    .justify-between { justify-content: space-between; }
                    .text-green-700 { color: #059669; }
                    .text-red-700 { color: #dc2626; }
                    .text-indigo-700 { color: #4338ca; }
                    .text-gray-700 { color: #374151; }
                    .text-red-500 { color: #ef4444; }
                </style>
            `);
            printWindow.document.write('</head><body>');
            printWindow.document.write(boucherContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        function displayMessage(message, type) {
            const msgBox = document.getElementById('message-box');
            let colorClass = '';
            switch(type) {
                case 'success': colorClass = 'bg-green-50 text-green-700 border-green-500'; break;
                case 'error': colorClass = 'bg-red-50 text-red-700 border-red-500'; break;
                case 'warning': colorClass = 'bg-yellow-50 text-yellow-700 border-yellow-500'; break;
                default: colorClass = 'bg-blue-50 text-blue-700 border-blue-500';
            }
            msgBox.textContent = message;
            msgBox.className = `fixed top-0 left-0 right-0 p-4 border-l-4 font-medium z-50 transition duration-300 ${colorClass} shadow-xl`;
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.display = 'none'; }, 5000);
        }
    </script>
    
    <style>
        /* Base para el estilo "Mobile App" */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue/gray background */
            padding-bottom: 120px; /* Espacio para la barra de resumen fija */
        }

        /* Estilo general de inputs de números para mobile, AHORA CENTRADO */
        .input-field-mobile {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb; /* Fondo claro para inputs */
            text-align: center; /* CLAVE: CENTRAR EL TEXTO DE LOS INPUTS */
        }

        .input-field-mobile:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            background-color: #ffffff;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .history-scroll-container {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .history-card {
            min-width: 280px; /* Un poco más ancho para el detalle */
            flex-shrink: 0;
        }
        
        .fixed-summary-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            background-color: #ffffff;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
    </style>
</head>
<body class="min-h-screen">
    <div id="message-box" style="display:none;"></div>
    
    <div id="main-report-area" class="max-w-xl mx-auto p-4 sm:p-6 pb-32"> <!-- Espacio extra al final para el fixed-summary-bar -->
        
        <!-- Header de la App -->
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900">Reporte Diario</h1>
        </header>

        <!-- Tarjeta de Datos de Encabezado -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border border-indigo-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Detalles del punto</h2>
            <div class="space-y-3">
                <!-- POS Name -->
                <div>
                    <label for="pos-name" class="block text-sm font-medium text-gray-700 mb-1">Punto de Venta (POS)</label>
                    <input type="text" id="pos-name" placeholder="Ej: POS Tienda Principal" required class="input-field-mobile w-full bg-indigo-50 border-indigo-300">
                </div>
                <!-- Date (Cambiado a texto de solo lectura para eliminar el calendario) -->
                <div>
                    <label for="report-date-display" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Registro</label>
                    <input type="text" id="report-date-display" readonly class="input-field-mobile w-full bg-gray-100 border-gray-300 cursor-default font-bold text-base">
                    <!-- Campo oculto para guardar la fecha en formato ISO (YYYY-MM-DD) -->
                    <input type="hidden" id="report-date-value">
                </div>
            </div>
        </div>

        <!-- LISTA DE PRODUCTOS (Inputs) -->
        <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8">Inventario de Productos</h3>
        <div id="report-list" class="space-y-4">
            <!-- Tarjetas de producto dinámicas se insertan aquí -->
        </div>

        <!-- Botón Flotante/Principal para Añadir Item (Mobile Style) -->
        <div class="mt-6 flex justify-center">
            <button id="add-product-btn" class="flex items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-300 transform hover:scale-105 active:scale-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Añadir Otro Producto
            </button>
        </div>
        
        <!-- MODIFICADO: SECCIÓN DE GASTOS Y SALDO EN CAJA (DINÁMICO) -->
        <div class="bg-white p-4 rounded-xl shadow-lg mt-8 mb-6 border border-green-300">
            <h2 class="text-lg font-bold text-green-700 mb-3 border-b pb-2">Movimientos y Saldo en Caja</h2>
             
             <div class="space-y-3">
                 <!-- DINERO EN CAJA (Valor real) -->
                 <div class="pt-2">
                    <label for="cash-amount" class="block text-sm font-medium text-gray-700 mb-1">Dinero en Caja</label>
                    <input type="number" id="cash-amount" value="0" min="0" step="1000" inputmode="numeric" class="input-field-mobile w-full text-center bg-green-50 border-green-300 font-bold text-xl">
                 </div>
                 
                 <!-- NUEVO: VALOR DESAYUNO EMPLEADO (Resta a la venta) -->
                 <div class="pt-2 border-t border-gray-100">
                    <label for="employee-breakfast" class="block text-sm font-medium text-gray-700 mb-1">Desayuno</label>
                    <input type="number" id="employee-breakfast" value="0" min="0" step="1000" inputmode="numeric" class="input-field-mobile w-full text-center bg-red-50 border-red-300 font-bold text-xl">
                 </div>

                 <!-- Contenedor Dinámico de Movimientos -->
                 <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Movimientos de Caja</h3>
                     <div id="movements-list">
                         <!-- Aquí se agregarán dinámicamente los inputs de gastos/ingresos -->
                     </div>
                 </div>
                 
                 <!-- Botón para agregar movimiento -->
                 <button id="add-movement-btn" type="button" class="w-full flex items-center justify-center px-4 py-2 bg-blue-50 text-blue-700 font-semibold rounded-lg border border-blue-200 hover:bg-blue-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Agregar Gasto / Ingreso
                 </button>
                 
             </div>
        </div>


        <!-- Historial (Mobile-friendly horizontal scroll) -->
        <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8">Historial - (Últimos Reportes)</h3>
        
        <div id="report-history-cards" class="history-scroll-container">
             <!-- Tarjetas de historial se cargan aquí -->
        </div>
        
    </div>
    
    <!-- BARRA DE RESUMEN FIJA INFERIOR (Mobile App Style) -->
    <div class="fixed-summary-bar">
        <div class="grid grid-cols-2 gap-4 mb-3 border-b pb-3"> 
            <!-- Valor Total Mercancia (Ventas Esperadas Netas) -->
            <div>
                <p class="text-xs font-medium text-gray-500">Valor Mercancia</p>
                <p id="grand-total-sales-display" class="text-2xl font-extrabold text-green-700">0</p>
            </div>
            <!-- Saldo Faltante/Favor -->
            <div>
                <p id="cash-difference-label" class="text-xs font-medium text-gray-500">Saldo (Cero)</p>
                <p id="cash-difference-display" class="text-2xl font-extrabold text-gray-600">0</p>
            </div>
        </div>
        
        <button id="save-report-btn" class="w-full px-6 py-4 bg-indigo-600 text-white text-lg font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-400/50 transform hover:scale-[1.01] active:scale-95">
            GUARDAR Y GENERAR REPORTE
        </button>
    </div>
    
    
    <!-- MODAL PARA EL BOUCHER -->
    <div id="boucher-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-11/12 mx-auto modal-content-card" role="dialog" aria-modal="true">
            <h3 class="text-2xl font-bold text-center text-gray-900 mb-4">Reporte Punto</h3>
            
            <!-- Contenedor con scroll añadido -->
            <div class="max-h-96 overflow-y-auto pr-2">
                <div id="boucher-content" class="text-sm">
                    <!-- Contenido del Boucher va aquí -->
                    <div id="boucher-body" class="mb-4">
                        <!-- Contenido dinámico -->
                    </div>
                </div>
            </div>

            <!-- Botones de acción del modal -->
            <div class="flex flex-col space-y-3 mt-5">
                <!-- MODIFICADO: BOTÓN DE COMPARTIR PDF -->
                <button id="share-boucher-btn" class="flex items-center justify-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.314l4.94 2.47a3 3 0 10.832-1.664l-4.94-2.47a3.02 3.02 0 000-1.099l4.94-2.47A3 3 0 0015 8z" />
                    </svg>
                    Compartir Reporte (PDF)
                </button>
                
                <!-- BOTÓN DE IMPRIMIR/PDF (Función existente) -->
                <button id="print-boucher-btn" class="flex items-center justify-center px-4 py-3 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2v-3a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Imprimir / Descargar PDF
                </button>
                <button id="close-modal-btn" class="px-4 py-2 text-gray-600 bg-gray-100 font-medium rounded-xl hover:bg-gray-200 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
